#!/usr/bin/env bash

source $IMPROMPTU_BIN/impromptu-utils
impromptu_ensure_constants

# Check for version or help flags.
if [[ -n "$1" ]]; then
  if [[ "$1" == "-v" || "$1" == "--version" ]]; then
    $IMPROMPTU_BIN/impromptu-node-cli $1
  fi

  if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    $IMPROMPTU_BIN/impromptu-node-cli $1
  fi

  if [[ "$1" == "--no-server" ]]; then
    impromptu_set_prompt_command impromptu-node-cli
  fi

  if [[ "$1" == "prompt" ]]; then
    if [[ -n "$2" && "$2" == "--no-server" ]]; then
      $IMPROMPTU_BIN/impromptu-node-cli
    else
      source $IMPROMPTU_BIN/impromptu-client
    fi
  fi

  if [[ "$1" == "server" ]]; then
    if [[ -n "$2" ]]; then
      if [[ "$2" == "start" ]]; then
        impromptu_ping_server
        if [[ "$?" -eq 0 ]]; then
          echo "The Impromptu server is already running."
        else
          if [[ -n "$3" && "$3" == "--foreground" ]]; then
            impromptu_ensure_server --foreground
          else
            impromptu_ensure_server
          fi
        fi
      elif [[ "$2" == "shutdown" ]]; then
        echo -n "shutdown" | impromptu_server_connection
      fi
    fi
  fi

  exit
fi

impromptu_ensure_server
impromptu_set_prompt_command impromptu-client
