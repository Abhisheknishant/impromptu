#!/usr/bin/env bash

# The proxy is invoked by the socket server.
SOCKET=$1

# Alias `tu` to pass all arguments through the socket.
tu() {
  echo "$@" | nc -U $SOCKET 2>&1
}

tu "hello world"


# The filename for tufiles.
TUFILE=".tu"

PWD=$(pwd)
USER_TUFILE="$HOME/$TUFILE"

# Find the project's tufile, which is the first tufile in the directory tree.
while [ $PWD ]; do
  PROJECT_TUFILE="$PWD/$TUFILE"
  echo "Checking $PROJECT_TUFILE"

  # Stop at the first tufile located.
  if [ -f $PROJECT_TUFILE ]; then
    break;
  fi

  PWD=$(dirname $PWD)

  # Special handling for the root directory.
  if [ $PWD == "/" ]; then
    PROJECT_TUFILE="/$TUFILE";
    if [ ! -f $PROJECT_TUFILE ]; then
      PROJECT_TUFILE="";
    fi
    break;
  fi
done

# Load the user's tufile.
if [ -f $USER_TUFILE ]; then
  source $USER_TUFILE;
fi

# Load the project's tufile.
if [[ -n $PROJECT_TUFILE && $PROJECT_TUFILE != $USER_TUFILE && -f $PROJECT_TUFILE ]]; then
  source $PROJECT_TUFILE;
fi

tu exit